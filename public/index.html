<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Angry Remote</title>

<style>
:root{
 --bg:#0e0f13;
 --panel:#161823;
 --btn:#2a2d3a;
 --primary:#6b4cff;
 --danger:#ff3b30;
 --text:#f5f6ff;
 --muted:#a9acc2;
 font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
body{margin:0;background:var(--bg);color:var(--text)}
.wrap{max-width:700px;margin:auto;padding:16px}
.badge{background:var(--panel);padding:10px 14px;border-radius:999px;display:inline-block;margin-right:8px}
.tabs{display:flex;gap:8px;margin:12px 0}
.tab{flex:1;padding:12px;border-radius:999px;border:1px solid #2d3146;background:var(--panel);color:white;font-weight:700}
.tab.active{outline:2px solid var(--primary)}
.panel{background:var(--panel);padding:16px;border-radius:18px;border:1px solid #2d3146}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
button{padding:16px;border-radius:16px;border:0;font-weight:800;background:var(--btn);color:white}
button.primary{background:var(--primary)}
button.danger{background:var(--danger)}
input{padding:10px;border-radius:12px;border:1px solid #2d3146;background:#111;color:white}
</style>
</head>

<body>
<div class="wrap">

<div>
<span class="badge">CODE: <b id="codeLabel">----</b></span>
<span class="badge">Stage: <b id="stageLabel">---</b></span>
</div>

<div class="tabs">
<button class="tab active" id="p1">P1</button>
<button class="tab" id="p2">P2</button>
<button class="tab" id="wait">WAIT</button>
</div>

<div class="panel">
<input id="codeInput" placeholder="CODE"/>
<button onclick="saveCode()">OK</button>

<div id="buttons" class="grid"></div>
</div>

</div>

<script>
const qs = new URLSearchParams(location.search);

let state = {
 code: (qs.get("code")||"").toUpperCase(),
 player: "P1",
 stage: "start"
};

const codeLabel = document.getElementById("codeLabel");
const stageLabel = document.getElementById("stageLabel");
const buttonsEl = document.getElementById("buttons");

function saveCode(){
 state.code = document.getElementById("codeInput").value.toUpperCase();
 codeLabel.textContent = state.code;
}

function setPlayer(p){
 state.player = p;
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
 document.getElementById(p.toLowerCase()).classList.add("active");
 renderButtons();
}

function setStage(s){
 if(!s) return;
 state.stage = s;
 stageLabel.textContent = s;
 renderButtons();
}

async function send(cmd){
 if(!state.code){ alert("Falta CODE"); return; }

 await fetch("/api/send",{
   method:"POST",
   headers:{ "Content-Type":"application/json" },
   body:JSON.stringify({ code:state.code, cmd })
 });
}

const BUTTONS = {
 start:[
  ["PLAY","PLAY","primary"],
  ["TRAILER","TRAILER",""],
  ["EXIT","EXIT","danger"]
 ],
 select:[
  ["LEFT","LEFT",""],
  ["RIGHT","RIGHT",""],
  ["PLAY","PLAY","primary"],
  ["HOME","HOME",""],
  ["EXIT","EXIT","danger"]
 ],
 level:[
  ["HOME","HOME",""],
  ["RESTART","RESTART",""],
  ["EXIT","EXIT","danger"]
 ],
 wait:[
  ["LINDA 0","LINDAACCION0","primary"],
  ["LINDA 1","LINDAACCION1","primary"]
 ]
};

function renderButtons(){
 buttonsEl.innerHTML="";
 const list = BUTTONS[state.stage] || BUTTONS.start;

 for(const [label,cmd,css] of list){
  const b=document.createElement("button");
  b.textContent=label;
  if(css) b.classList.add(css);

  b.onclick=()=>{
   if(state.player==="WAIT")
    send(`WAIT_${cmd}`);
   else
    send(`${state.player}_${cmd}`);
  };

  buttonsEl.appendChild(b);
 }
}

async function pollPresence(){
 if(!state.code) return;

 try{
   const r = await fetch(`/api/presence?code=${state.code}`);
   const j = await r.json();
   if(j && j.stage && j.stage !== state.stage){
     setStage(j.stage);
   }
 }catch(e){}
}

document.getElementById("p1").onclick=()=>setPlayer("P1");
document.getElementById("p2").onclick=()=>setPlayer("P2");
document.getElementById("wait").onclick=()=>setPlayer("WAIT");

codeLabel.textContent = state.code || "----";
renderButtons();
setInterval(pollPresence, 600);
</script>
</body>
</html>
