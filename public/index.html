<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Angry Remote</title>

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#131826;
      --panel2:#0f1320;
      --line:#232a3d;
      --btn:#20263a;
      --btnHi:#6b4cff;
      --danger:#ff3b30;
      --text:#f4f6ff;
      --muted:#aab0c6;
      --radius:18px;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    body{margin:0;background:radial-gradient(1200px 600px at 30% 0%, #141a2b 0%, var(--bg) 55%); color:var(--text);}
    .wrap{max-width:820px;margin:0 auto;padding:16px 14px 28px;}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .chip{
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      display:flex;gap:10px;align-items:center;
      box-shadow: var(--shadow);
    }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      color:var(--muted);
      background:rgba(0,0,0,.10);
    }
    .ok{color:#41d07a;font-weight:800}

    .tabs{display:flex;gap:10px;margin:12px 0;}
    .tab{
      flex:1;
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border:1px solid var(--line);
      color:var(--text);
      padding:14px 12px;
      border-radius:999px;
      font-weight:800;
      box-shadow: var(--shadow);
    }
    .tab.active{outline:2px solid var(--btnHi);}

    .panel{
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border-radius:var(--radius);
      padding:14px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .hint{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.2}

    select,input{
      background:#0b0f1c;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
    }
    input{min-width:140px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
    button{
      border:0;border-radius:16px;padding:16px 14px;font-weight:900;
      background:var(--btn);color:var(--text);font-size:16px;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .05s ease;
    }
    button:active{transform: scale(.99);}
    button.primary{background:linear-gradient(180deg, #7a61ff 0%, var(--btnHi) 100%);}
    button.danger{background:linear-gradient(180deg, #ff5b52 0%, var(--danger) 100%);}
    button.ghost{background:transparent;border:1px solid var(--line);box-shadow:none;color:var(--muted);}

    .spacer{height:8px}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="chip">
        <div class="pill">CODE: <b id="codeLabel">----</b></div>
        <div class="pill"><span class="ok" id="online">online</span></div>
      </div>

      <div class="chip">
        <span class="pill">Etapa</span>
        <select id="stage">
          <option value="start">StartScene (Menú)</option>
          <option value="select">LevelSelect</option>
          <option value="level">Level (Gameplay)</option>
          <option value="wait">Espera (Linda)</option>
        </select>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabP1">Player 1</button>
      <button class="tab" id="tabP2">Player 2</button>
      <button class="tab" id="tabW">Espera</button>
    </div>

    <div class="panel">
      <div class="row">
        <div>
          <div class="hint">Escaneá el QR, abrí esta página, elegí etapa y apretá botones.</div>
          <div class="hint">Importante: la página NO manda nada automáticamente.</div>
        </div>

        <div class="row">
          <input id="codeInput" placeholder="CODE (ej: JLYF)" />
          <button class="ghost" id="saveCode">OK</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div id="buttons" class="grid"></div>
    </div>

  </div>

<script>
  // ---------- Estado ----------
  const qs = new URLSearchParams(location.search);

  // Default: START (menú). Si viene por URL, lo usamos.
  const state = {
    code: (qs.get("code") || "").toUpperCase().trim(),
    player: (qs.get("player") || "P1").toUpperCase(),
    stage: (qs.get("stage") || "start").toLowerCase()
  };

  // Normalizamos valores permitidos
  if(!["P1","P2","WAIT"].includes(state.player)) state.player = "P1";
  if(!["start","select","level","wait"].includes(state.stage)) state.stage = "start";

  const codeLabel = document.getElementById("codeLabel");
  const codeInput = document.getElementById("codeInput");
  const stageSel  = document.getElementById("stage");
  const buttonsEl = document.getElementById("buttons");

  function setPlayer(p){
    state.player = p;
    document.getElementById("tabP1").classList.toggle("active", p==="P1");
    document.getElementById("tabP2").classList.toggle("active", p==="P2");
    document.getElementById("tabW").classList.toggle("active", p==="WAIT");
    renderButtons();
    updateUrl();
  }

  function setStage(s){
    state.stage = s;
    stageSel.value = s;
    renderButtons();
    updateUrl();
  }

  function setCode(c){
    state.code = (c || "").toUpperCase().trim();
    codeLabel.textContent = state.code || "----";
    codeInput.value = state.code;
    updateUrl();
  }

  function updateUrl(){
    const url = new URL(location.href);
    if(state.code) url.searchParams.set("code", state.code); else url.searchParams.delete("code");
    url.searchParams.set("stage", state.stage);
    url.searchParams.set("player", state.player);
    history.replaceState({}, "", url.toString());
  }

  async function send(cmd, data=null){
    if(!state.code){ alert("Falta CODE"); return; }

    try{
      const r = await fetch("/api/send",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ code: state.code, player: state.player, cmd, data })
      });

      if(!r.ok){
        const txt = await r.text().catch(()=> "");
        alert("No pude enviar ("+r.status+"). " + txt);
        return;
      }

      navigator.vibrate?.(25);

    }catch(e){
      alert("No pude enviar. ¿Servidor dormido? Reintentá.");
    }
  }

  // ---------- Botones por etapa (solo lo que corresponde) ----------
  // NOTA: Los comandos se envían como:
  //   P1_PLAY, P2_TRAILER, WAIT_LINDAACCION0, etc.
  const BUTTONS = {
    start: [
      ["PLAY", "PLAY", "primary"],
      ["TRAILER", "TRAILER", ""],
      ["CLOSE TRAILER", "EXITTRAILER", ""],
      ["EXIT", "EXIT", "danger"]
    ],
    select: [
      ["LEFT", "LEFT", ""],
      ["RIGHT", "RIGHT", ""],
      ["PLAY", "PLAY", "primary"],
      ["HOME", "HOME", ""],
      ["EXIT", "EXIT", "danger"]
    ],
    level: [
      ["OVEJITA", "OVEJITA", "primary"],
      ["PODER OVEJITA", "OVEJITAENOJADAPODER", ""],
      ["PATITO", "PATITO", "primary"],
      ["PODER PATITO", "PATITOENOJADOPODER", ""],
      ["CABRITA", "CABRITA", "primary"],
      ["PODER CABRITA", "CABRITAENOJADAPODER", ""],
      ["CARPINCHA", "CARPINCHA", "primary"],
      ["PODER CARPINCHA", "CARPINCHAENOJADAPODER", ""],
      ["VAQUITA", "VAQUITA", "primary"],
      ["PODER VAQUITA", "VAQUITAENOJADAPODER", ""],
      ["PODER ARGENTINO", "PODERARGENTINO", "primary"],
      ["HOME", "HOME", ""],
      ["EXIT", "EXIT", "danger"]
    ],
    wait: [
      ["LINDA 0", "LINDAACCION0", "primary"],
      ["LINDA 1", "LINDAACCION1", "primary"],
      ["LINDA 2", "LINDAACCION2", "primary"],
      ["LINDA 3", "LINDAACCION3", "primary"]
    ]
  };

  function renderButtons(){
    const list = BUTTONS[state.stage] || [];
    buttonsEl.innerHTML = "";

    for(const [label, cmd, css] of list){
      const b = document.createElement("button");
      b.textContent = label;
      if(css) b.classList.add(css);

      b.onclick = () => {
        // Prefijo por jugador (P1_/P2_) salvo WAIT
        const full = (state.player === "WAIT")
          ? `WAIT_${cmd}`
          : `${state.player}_${cmd}`;
        send(full);
      };

      buttonsEl.appendChild(b);
    }
  }

  // ---------- Events ----------
  document.getElementById("tabP1").onclick = () => setPlayer("P1");
  document.getElementById("tabP2").onclick = () => setPlayer("P2");
  document.getElementById("tabW").onclick  = () => setPlayer("WAIT");

  stageSel.onchange = () => setStage(stageSel.value);

  document.getElementById("saveCode").onclick = () => setCode(codeInput.value);

  // ---------- Init ----------
  setCode(state.code);
  setStage(state.stage);
  setPlayer(state.player);
  renderButtons();
</script>
</body>
</html>
